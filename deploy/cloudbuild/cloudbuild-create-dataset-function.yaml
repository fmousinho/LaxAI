############################################################################
#                                                                          #
#               BUILDER FOR SERVICE CR CREATE DATASET FROM PLAYER MGR     #
#                                                                          #
############################################################################

# This Cloud Build file builds a Docker image, pushes it to Artifact
# Registry, and deploys it to a Cloud Run service.


substitutions:
  _GOOGLE_CLOUD_PROJECT: "laxai-466119"
  _SERVICE_ACCOUNT: "service-create-dataset@laxai-466119.iam.gserviceaccount.com"
  _FUNCTION_NAME: "laxai-create-dataset"
  _REGION: "us-central1"

steps:
  - id: "prepare-deployment"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        # Create clean deployment directory with only necessary files
        mkdir -p /workspace/deployment
        cd /workspace/deployment

        # Copy only the proxy service
        cp -r ../services/service_cr_create_dataset_from_player_mgr/* ./

        # Copy only shared_libs
        cp -r ../shared_libs ./

        echo "Prepared clean deployment with proxy + shared_libs only"

  - id: "deploy-cloud-function"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "gcloud"
    args:
      - "functions"
      - "deploy"
      - "${_FUNCTION_NAME}"
      - "--region=${_REGION}"
      - "--runtime=python312"
      - "--source=/workspace/deployment"
      - "--entry-point=process_pubsub_message"
      - "--trigger-topic=tracking-jobs"
      - "--service-account=${_SERVICE_ACCOUNT}"
      - "--set-env-vars=GOOGLE_CLOUD_PROJECT=${_GOOGLE_CLOUD_PROJECT},CLOUD_REGION=${_REGION}"
      - "--memory=512MB"
      - "--timeout=540s"
      - "--max-instances=10"
      - "--ingress-settings=internal-only"
      - "--quiet"

options:
  logging: CLOUD_LOGGING_ONLY

timeout: "1800s"