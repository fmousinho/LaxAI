############################################################################
#                                                                          #
#                    SIMPLIFIED BUILDER FOR API LAYERS                     #
#                                                                          #
############################################################################

# This Cloud Build file builds a Docker image, pushes it to Artifact
# Registry, and deploys it to a CPU-based Cloud Run service.

steps:
  - id: "build-and-tag-image"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-f"
      - "docker/thin_api/Dockerfile"
      - "-t"
      - "us-central1-docker.pkg.dev/${PROJECT_ID}/laxai-repo/laxai-api:latest"
      - "--build-arg"
      - "REQS=requirements-cloud.txt"
      - "--build-arg"
      - "GOOGLE_CLOUD_PROJECT=${PROJECT_ID}"
      - "."

  - id: "push-latest-image"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "us-central1-docker.pkg.dev/${PROJECT_ID}/laxai-repo/laxai-api:latest"

  - id: "deploy-to-cloud-run"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "gcloud"
    args:
      - "run"
      - "deploy"
      - "laxai-api"
      - "--image=us-central1-docker.pkg.dev/${PROJECT_ID}/laxai-repo/laxai-api:latest"
      - "--region=us-central1"
      - "--cpu=1"
      - "--memory=512Mi"
      - "--max-instances=3"
      - "--timeout=300s"
      - "--concurrency=10"
      - "--service-account=googlebatch@${PROJECT_ID}.iam.gserviceaccount.com"
      - "--no-allow-unauthenticated"
      - "--quiet"

images:
  - "us-central1-docker.pkg.dev/${PROJECT_ID}/laxai-repo/laxai-api:latest"

options:
  logging: CLOUD_LOGGING_ONLY

timeout: "3600s"
