# Cloud Build configuration for LaxAI
# Builds Docker image, pushes to Artifact Registry and deploys to Cloud Run.

substitutions:
  # Build-time and deployment substitutions. Override these when calling `gcloud builds`
  # or when creating a build trigger.
  _IMAGE: "laxai"
  _REQS: "requirements-cpu.txt"        # maps from docker-compose build arg REQS   
  _CLOUD_RUN_SERVICE: "laxai-api"
  _CLOUD_RUN_REGION: "us-central1"
  _DEPLOY_TO_CLOUD_RUN: "true"       # set to "true" to run the deploy step
  

steps:
  # Build the final production image, tagging it with both the unique SHA and "latest".
  - id: "build-and-tag-image"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-t"
      - "us-central1-docker.pkg.dev/$PROJECT_ID/laxai-repo/${_IMAGE}:${SHORT_SHA}"
      - "-t"
      - "us-central1-docker.pkg.dev/$PROJECT_ID/laxai-repo/${_IMAGE}:latest"
      - "--build-arg"
      - "REQS=${_REQS}"
      - "--build-arg"
      - "GOOGLE_CLOUD_PROJECT=$PROJECT_ID"
      - "."

  # Push the two newly created tags (SHA and latest) to Artifact Registry in a single step.
  - id: "push-images"
    name: "gcr.io/cloud-builders/docker"
    args: 
      - "push" 
      - "us-central1-docker.pkg.dev/$PROJECT_ID/laxai-repo/${_IMAGE}:${SHORT_SHA}"
    
  # Push the :latest tag as well. This can be combined with the previous push command if preferred.
  - id: "push-latest-image"
    name: "gcr.io/cloud-builders/docker"
    args: 
      - "push" 
      - "us-central1-docker.pkg.dev/$PROJECT_ID/laxai-repo/${_IMAGE}:latest"

  # Deploy to Cloud Run using the "latest" tag.
  - id: "deploy-to-cloud-run"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        if [[ "${_DEPLOY_TO_CLOUD_RUN}" == "true" ]]; then
          echo "Deploying to Cloud Run: ${_CLOUD_RUN_SERVICE} (${_CLOUD_RUN_REGION})"
          gcloud run deploy "${_CLOUD_RUN_SERVICE}" \
            --image="us-central1-docker.pkg.dev/$PROJECT_ID/laxai-repo/${_IMAGE}:latest" \
            --region="${_CLOUD_RUN_REGION}" \
            --platform=managed \
            --allow-unauthenticated \
            --quiet
        else
          echo "Skipping Cloud Run deployment because _DEPLOY_TO_CLOUD_RUN != true"
        fi

# Images to be built and pushed to Artifact Registry
images:
  - "us-central1-docker.pkg.dev/$PROJECT_ID/laxai-repo/${_IMAGE}:${SHORT_SHA}"
  - "us-central1-docker.pkg.dev/$PROJECT_ID/laxai-repo/${_IMAGE}:latest"

# Optional: make a secret available from Secret Manager to build steps.
# Replace the versionName below with the actual secret resource name.
availableSecrets:
  secretManager: []

options:
  logging: CLOUD_LOGGING_ONLY

timeout: "3600s"  # 60 minutes